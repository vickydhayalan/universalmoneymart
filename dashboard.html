<script>
    // --- 1. Mock Data --- (Kept original data)
    const lineData = [
        { month: "Jan", value: 42000 }, { month: "Feb", value: 43500 }, { month: "Mar", value: 41000 }, 
        { month: "Apr", value: 45000 }, { month: "May", value: 47500 }, { month: "Jun", value: 46000 }, 
        { month: "Jul", value: 48500 }, { month: "Aug", value: 51000 }, { month: "Sep", value: 49500 }, 
        { month: "Oct", value: 52000 }, { month: "Nov", value: 54500 }, { month: "Dec", value: 56000 }
    ];
    const pieData = [
        { asset: "Equity", value: 65 }, { asset: "Debt", value: 25 }, { asset: "Gold", value: 10 }
    ];
    const barData = [
        { sector: "Tech", percentage: 25 }, { sector: "Finance", percentage: 20 }, { sector: "Pharma", percentage: 15 }, 
        { sector: "Auto", percentage: 12 }, { sector: "FMCG", percentage: 10 }
    ];
    const formatCurrency = d3.format("$,.0f");

    // -----------------------------------------------------
    // --- 2. LIVE DATA FETCHING FUNCTION (REAL API CALLS) ---
    // -----------------------------------------------------
    function fetchLiveData() {
        // ðŸ”‘ Unga API Key Inga Use Pannirukken!
        const API_KEY = "JPPFNZHKQSM6FV98"; 

        // Helper function to update card UI
        const updateCard = (id, price, change, isPositive) => {
            document.getElementById(`${id}-price`).textContent = price;
            const changeElement = document.getElementById(`${id}-change`);
            const arrow = isPositive ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
            changeElement.innerHTML = `${arrow} ${change}`;
            changeElement.className = `text-xs font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`;
        };

        // --- 1. Fetch SENSEX Price (Using BSE.BOM Symbol) ---
        fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=BSE.BOM&apikey=${API_KEY}`)
            .then(response => response.json())
            .then(data => {
                if (data['Global Quote']) {
                    const quote = data['Global Quote'];
                    const price = parseFloat(quote['05. price']).toFixed(2);
                    const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
                    
                    updateCard('sensex', `â‚¹${price}`, `${changePercent}%`, changePercent >= 0);
                } else {
                    document.getElementById('sensex-price').textContent = 'API Limit';
                    document.getElementById('sensex-change').textContent = 'Try again later';
                }
            })
            .catch(err => {
                document.getElementById('sensex-price').textContent = 'Net Error';
                document.getElementById('sensex-change').textContent = 'Failed to fetch';
            });
            
        // --- 2. Fetch USD/INR Rate ---
        fetch(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=INR&apikey=${API_KEY}`)
            .then(response => response.json())
            .then(data => {
                if (data['Realtime Currency Exchange Rate']) {
                    const rate = parseFloat(data['Realtime Currency Exchange Rate']['5. Exchange Rate']).toFixed(2);
                    // Since change data isn't easy to extract here, we'll show just the rate
                    updateCard('usdinr', rate, `Forex Rate`, true); 
                } else {
                    document.getElementById('usdinr-price').textContent = 'API Limit';
                }
            })
            .catch(err => {
                 document.getElementById('usdinr-price').textContent = 'Net Error';
            });

        // --- 3. NIFTY & GOLD (Placeholders for complex symbols/APIs) ---
        // Nifty-kku: Alpha Vantage-la Indian indices symbols maara laam (e.g., NSE.NSE, NSEI). Neenga correct symbol-a use pannanum.
        document.getElementById('nifty-price').textContent = '---.--'; 
        document.getElementById('nifty-change').innerHTML = 'Verify Symbol';

        // Gold-kku: XAU symbol use pannanum, aana Gold API rates vera service-la irukkum (e.g., metals-api)
        document.getElementById('gold-price').textContent = 'â‚¹--.--';
        document.getElementById('gold-change').innerHTML = 'Need Gold API';
    }


    // --- 3. Chart Rendering Functions --- (Kept original functions)
    function drawLineChart() { /* ... function code ... */ }
    function drawPieChart() { /* ... function code ... */ }
    function drawBarChart() { /* ... function code ... */ }
    function drawLineChart() {
        const container = document.querySelector(".lg\\:col-span-2.h-\\[400px\\] .chart-container");
        const margin = { top: 30, right: 30, bottom: 50, left: 60 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = container.clientHeight - margin.top - margin.bottom - 40; 
        d3.select("#line-chart").html(""); 
        const svg = d3.select("#line-chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scalePoint()
            .domain(lineData.map(d => d.month))
            .range([0, width])
            .padding(0.5);
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickSizeOuter(0))
            .selectAll("text").style("font-size", "12px");
        const y = d3.scaleLinear()
            .domain([d3.min(lineData, d => d.value) - 1000, d3.max(lineData, d => d.value) + 1000])
            .range([height, 0]);
        svg.append("g").call(d3.axisLeft(y).tickFormat(d3.format("~s"))).selectAll("text").style("font-size", "12px");
        const line = d3.line().x(d => x(d.month)).y(d => y(d.value)).curve(d3.curveMonotoneX);
        svg.append("path").datum(lineData).attr("fill", "none").attr("stroke", "#007bff").attr("stroke-width", 3).attr("d", line);
        svg.selectAll("dot").data(lineData).enter().append("circle").attr("cx", d => x(d.month)).attr("cy", d => y(d.value)).attr("r", 5).attr("fill", "#004080");
        svg.append("text").attr("x", width / 2).attr("y", -5).attr("text-anchor", "middle").style("font-size", "14px").text("Portfolio Value Trend");
    }
    function drawPieChart() {
        const container = document.getElementById("pie-chart").parentNode;
        const margin = 20;
        const width = container.clientWidth - margin;
        const height = container.clientHeight - margin;
        const radius = Math.min(width, height) / 2.5;
        d3.select("#pie-chart").html(""); 
        const svg = d3.select("#pie-chart").attr("width", width + margin).attr("height", height + margin).append("g").attr("transform", `translate(${width / 2 + margin / 2}, ${height / 2 + margin / 2})`);
        const color = d3.scaleOrdinal().domain(pieData.map(d => d.asset)).range(["#4299e1", "#38b2ac", "#ecc94b"]); 
        const pie = d3.pie().value(d => d.value);
        const data_ready = pie(pieData);
        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);
        svg.selectAll('slices').data(data_ready).enter().append('path').attr('d', arc).attr('fill', d => color(d.data.asset)).attr("stroke", "white").style("stroke-width", "2px");
        svg.selectAll('labels').data(data_ready).enter().append('text').text(d => d.data.asset + " (" + d.data.value + "%)").attr("transform", d => `translate(${d3.arc().innerRadius(radius * 0.8).outerRadius(radius).centroid(d)})`).style("text-anchor", "middle").style("font-size", "12px");
    }
    function drawBarChart() {
        const container = document.getElementById("bar-chart").parentNode;
        const margin = { top: 30, right: 30, bottom: 50, left: 60 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = container.clientHeight - margin.top - margin.bottom;
        d3.select("#bar-chart").html(""); 
        const svg = d3.select("#bar-chart").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().range([0, width]).domain(barData.map(d => d.sector)).padding(0.2);
        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").style("font-size", "12px");
        const y = d3.scaleLinear().domain([0, d3.max(barData, d => d.percentage) + 5]).range([height, 0]);
        svg.append("g").call(d3.axisLeft(y).tickFormat(d => d + "%")).selectAll("text").style("font-size", "12px");
        svg.selectAll("bar").data(barData).enter().append("rect").attr("x", d => x(d.sector)).attr("y", d => y(d.percentage)).attr("width", x.bandwidth()).attr("height", d => height - y(d.percentage)).attr("fill", "#f56565"); 
        svg.selectAll(".bar-label").data(barData).enter().append("text").attr("class", "bar-label").attr("x", d => x(d.sector) + x.bandwidth() / 2).attr("y", d => y(d.percentage) - 5).attr("text-anchor", "middle").text(d => d.percentage + "%").style("font-size", "12px").style("fill", "#1f2937");
    }

    // --- 4. Initial Load and Resize Handler --- 
    document.addEventListener('DOMContentLoaded', () => {
        const menuToggle = document.getElementById('menuToggle');
        const navLinks = document.getElementById('navLinks');
        const body = document.body;
        const dropdowns = document.querySelectorAll('.dropdown');

        // Navigation JS Logic
        if (menuToggle && navLinks) { menuToggle.addEventListener('click', () => { navLinks.classList.toggle('active'); body.classList.toggle('menu-open'); }); }
        dropdowns.forEach(dropdown => {
            const dropbtn = dropdown.querySelector('.dropbtn');
            dropbtn.addEventListener('click', function(event) {
                if (window.innerWidth <= 991) {
                    event.preventDefault(); 
                    dropdowns.forEach(otherDropdown => { if (otherDropdown !== dropdown) { otherDropdown.classList.remove('show'); } });
                    dropdown.classList.toggle('show');
                }
            });
        });
        window.addEventListener('click', function(event) {
            if (window.innerWidth <= 991 && navLinks.classList.contains('active')) {
                if (!navLinks.contains(event.target) && !menuToggle.contains(event.target)) { navLinks.classList.remove('active'); body.classList.remove('menu-open'); dropdowns.forEach(dropdown => { dropdown.classList.remove('show'); }); }
                if (event.target.matches('#navLinks a')) { navLinks.classList.remove('active'); body.classList.remove('menu-open'); }
            }
        });

        // Chart & Data Rendering
        function renderAll() {
            fetchLiveData(); // Call the live data function
            drawLineChart();
            drawPieChart();
            drawBarChart();
        }

        window.addEventListener('load', renderAll);
        window.addEventListener('resize', renderAll);
    });
</script>
