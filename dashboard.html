<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Visualization Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for Charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom Styles for Chart Containers */
        .chart-container {
            height: 350px;
            width: 100%;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background-color: white;
            padding: 10px;
        }
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        /* Style for D3 SVGs to ensure they are centered and visible */
        .chart-svg {
            display: block;
            margin: auto;
        }
        .summary-card {
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            background-color: white;
            transition: transform 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center py-6 bg-white shadow-md rounded-lg mb-8">
            <h1 class="text-4xl font-bold text-blue-800">Live Investment Data Dashboard</h1>
            <p class="text-gray-600 mt-2">Visualizing Mock Portfolio Performance and Allocation</p>
        </header>
        
        <!-- SUMMARY CARDS SECTION -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div class="summary-card border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm font-medium">Total Portfolio Value</p>
                <h2 class="text-3xl font-extrabold text-gray-800 mt-1">₹54,500</h2>
                <span class="text-xs text-green-600 font-semibold">+6.5% Since Last Month</span>
            </div>
            
            <div class="summary-card border-l-4 border-green-500">
                <p class="text-gray-500 text-sm font-medium">Year-to-Date Gain (YTD)</p>
                <h2 class="text-3xl font-extrabold text-gray-800 mt-1">₹12,500</h2>
                <span class="text-xs text-green-600 font-semibold">+22.9% Annualized</span>
            </div>
            
            <div class="summary-card border-l-4 border-red-500">
                <p class="text-gray-500 text-sm font-medium">Risk Score (Out of 10)</p>
                <h2 class="text-3xl font-extrabold text-gray-800 mt-1">7.5</h2>
                <span class="text-xs text-red-600 font-semibold">High Volatility Exposure</span>
            </div>

        </div>
        <!-- END SUMMARY CARDS SECTION -->

        <!-- Main Grid for Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Chart 1: Line Chart (Monthly Performance) -->
            <div class="lg:col-span-2 h-[400px]">
                <div class="chart-container h-full">
                    <div class="chart-title ml-4 mt-2">Mock Fund Performance (Last 12 Months)</div>
                    <svg id="line-chart" class="chart-svg"></svg>
                    
                    <!-- GEMINI ANALYSIS BUTTON -->
                    <div class="mt-4 text-center">
                        <button id="analyze-btn" onclick="runGeminiAnalysis()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            ✨ Get Expert Analysis (Tamil)
                        </button>
                    </div>
                    <div id="analysis-result" class="mt-4 p-4 text-sm bg-yellow-100 border border-yellow-300 text-gray-700 rounded-lg hidden">
                        <p id="analysis-text" class="font-semibold"></p>
                        <div id="analysis-loading" class="text-center hidden">
                            <svg class="animate-spin h-5 w-5 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-xs mt-1">Analyzing...</p>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Chart 2: Pie Chart (Asset Allocation) -->
            <div class="lg:col-span-1">
                <div class="chart-container h-full">
                    <div class="chart-title ml-4 mt-2">Current Asset Allocation</div>
                    <svg id="pie-chart" class="chart-svg"></svg>
                </div>
            </div>

            <!-- Chart 3: Bar Chart (Sector Exposure) -->
            <div class="lg:col-span-3">
                <div class="chart-container h-[400px]">
                    <div class="chart-title ml-4 mt-2">Sector Exposure (Top 5)</div>
                    <svg id="bar-chart" class="chart-svg"></svg>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. Mock Data ---
        const lineData = [
            { month: "Jan", value: 42000 },
            { month: "Feb", value: 43500 },
            { month: "Mar", value: 41000 },
            { month: "Apr", value: 45000 },
            { month: "May", value: 47500 },
            { month: "Jun", value: 46000 },
            { month: "Jul", value: 48500 },
            { month: "Aug", value: 51000 },
            { month: "Sep", value: 49500 },
            { month: "Oct", value: 52000 },
            { month: "Nov", value: 54500 },
            { month: "Dec", value: 56000 }
        ];

        const pieData = [
            { asset: "Equity", value: 65 },
            { asset: "Debt", value: 25 },
            { asset: "Gold", value: 10 }
        ];

        const barData = [
            { sector: "Tech", percentage: 25 },
            { sector: "Finance", percentage: 20 },
            { sector: "Pharma", percentage: 15 },
            { sector: "Auto", percentage: 12 },
            { sector: "FMCG", percentage: 10 }
        ];
        
        // Helper function for formatting currency
        const formatCurrency = d3.format("$,.0f");
        const apiKey = ""; // API key is provided by the canvas environment

        // --- 2. Gemini API Call Logic ---
        async function runGeminiAnalysis() {
            const resultDiv = document.getElementById('analysis-result');
            const resultText = document.getElementById('analysis-text');
            const loading = document.getElementById('analysis-loading');
            const analyzeBtn = document.getElementById('analyze-btn');

            analyzeBtn.disabled = true;
            loading.classList.remove('hidden');
            resultDiv.classList.remove('hidden');
            resultText.textContent = '';

            const dataSummary = `
                Monthly Value Trend: ${lineData.map(d => `${d.month}: ${d.value}`).join(', ')}. 
                Initial Value (Jan): ${lineData[0].value}. 
                Final Value (Dec): ${lineData[lineData.length - 1].value}.
                Asset Allocation: Equity ${pieData.find(d => d.asset === 'Equity').value}%, Debt ${pieData.find(d => d.asset === 'Debt').value}%, Gold ${pieData.find(d => d.asset === 'Gold').value}%.
                Top Sector Exposure: Tech ${barData[0].percentage}%, Finance ${barData[1].percentage}%.
            `;

            const systemPrompt = "Act as a conservative financial advisor specializing in Mutual Funds. Provide a brief, single-paragraph analysis of the provided investment data. Use encouraging and advisory tone. The entire response MUST be in Tamil (Latin Script - Tanglish).";
            
            const userQuery = `Analyze this mock portfolio performance data: ${dataSummary}. Give feedback on the risk profile and performance trend, specifically mentioning the asset allocation and trend from Jan to Dec.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            // Retry logic with exponential backoff (max 3 retries)
            const maxRetries = 3;
            let response;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429) {
                        // Too many requests - retry with backoff
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i === maxRetries - 1) throw new Error("API rate limit exceeded after all retries.");
                    } else {
                        // Other error - stop retrying
                        throw new Error(`API error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === maxRetries - 1) {
                        resultText.textContent = "Analysis failed. Please try again later. (Technical Error)";
                        loading.classList.add('hidden');
                        analyzeBtn.disabled = false;
                        return;
                    }
                }
            }

            try {
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis found.";
                resultText.textContent = text;
            } catch (e) {
                resultText.textContent = "Error processing the analysis response.";
                console.error("Error processing Gemini response:", e);
            }
            
            loading.classList.add('hidden');
            analyzeBtn.disabled = false;
        }


        // --- 3. Chart Rendering Functions ---

        // Function to draw the Line Chart
        function drawLineChart() {
            const container = document.getElementById("line-chart").parentNode;
            const margin = { top: 30, right: 30, bottom: 50, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;

            d3.select("#line-chart").html(""); // Clear SVG
            
            const svg = d3.select("#line-chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X axis
            const x = d3.scalePoint()
                .domain(lineData.map(d => d.month))
                .range([0, width])
                .padding(0.5);
            
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .style("font-size", "12px");

            // Y axis
            const y = d3.scaleLinear()
                .domain([d3.min(lineData, d => d.value) - 1000, d3.max(lineData, d => d.value) + 1000])
                .range([height, 0]);
            
            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format("~s")))
                .selectAll("text")
                .style("font-size", "12px");

            // Line generator
            const line = d3.line()
                .x(d => x(d.month))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            // Draw the line
            svg.append("path")
                .datum(lineData)
                .attr("fill", "none")
                .attr("stroke", "#007bff")
                .attr("stroke-width", 3)
                .attr("d", line);

            // Add dots
            svg.selectAll("dot")
                .data(lineData)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.month))
                .attr("cy", d => y(d.value))
                .attr("r", 5)
                .attr("fill", "#004080");

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -5)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Portfolio Value Trend");
        }

        // Function to draw the Pie Chart
        function drawPieChart() {
            const container = document.getElementById("pie-chart").parentNode;
            const margin = 20;
            const width = container.clientWidth - margin;
            const height = container.clientHeight - margin;
            const radius = Math.min(width, height) / 2.5;

            d3.select("#pie-chart").html(""); // Clear SVG

            const svg = d3.select("#pie-chart")
                .attr("width", width + margin)
                .attr("height", height + margin)
                .append("g")
                .attr("transform", `translate(${width / 2 + margin / 2}, ${height / 2 + margin / 2})`);

            const color = d3.scaleOrdinal()
                .domain(pieData.map(d => d.asset))
                .range(["#4299e1", "#38b2ac", "#ecc94b"]); // Blue, Teal, Yellow

            // Compute the position of each group on the pie
            const pie = d3.pie()
                .value(d => d.value);
            const data_ready = pie(pieData);

            // Arc generator
            const arc = d3.arc()
                .innerRadius(radius * 0.5) // Donut chart
                .outerRadius(radius);

            // Build the pie chart
            svg.selectAll('slices')
                .data(data_ready)
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.asset))
                .attr("stroke", "white")
                .style("stroke-width", "2px");

            // Add labels
            svg.selectAll('labels')
                .data(data_ready)
                .enter()
                .append('text')
                .text(d => d.data.asset + " (" + d.data.value + "%)")
                .attr("transform", d => `translate(${d3.arc().innerRadius(radius * 0.8).outerRadius(radius).centroid(d)})`)
                .style("text-anchor", "middle")
                .style("font-size", "12px");
        }

        // Function to draw the Bar Chart
        function drawBarChart() {
            const container = document.getElementById("bar-chart").parentNode;
            const margin = { top: 30, right: 30, bottom: 50, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;

            d3.select("#bar-chart").html(""); // Clear SVG

            const svg = d3.select("#bar-chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X axis
            const x = d3.scaleBand()
                .range([0, width])
                .domain(barData.map(d => d.sector))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "12px");

            // Y axis
            const y = d3.scaleLinear()
                .domain([0, d3.max(barData, d => d.percentage) + 5])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => d + "%"))
                .selectAll("text")
                .style("font-size", "12px");

            // Draw bars
            svg.selectAll("bar")
                .data(barData)
                .enter()
                .append("rect")
                .attr("x", d => x(d.sector))
                .attr("y", d => y(d.percentage))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.percentage))
                .attr("fill", "#f56565"); // Red/Salmon color

            // Add text labels on top of bars
            svg.selectAll(".bar-label")
                .data(barData)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.sector) + x.bandwidth() / 2)
                .attr("y", d => y(d.percentage) - 5)
                .attr("text-anchor", "middle")
                .text(d => d.percentage + "%")
                .style("font-size", "12px")
                .style("fill", "#1f2937");
        }

        // --- 4. Initial Load and Resize Handler ---
        function renderAllCharts() {
            drawLineChart();
            drawPieChart();
            drawBarChart();
        }

        window.addEventListener('load', renderAllCharts);
        window.addEventListener('resize', renderAllCharts);
    </script>
</body>
</html>
